@page "/reporting"
@using TicketSystem.Data
@using TicketSystem.Models
@using Microsoft.EntityFrameworkCore
@using Radzen
@using Radzen.Blazor
@using MiniExcelLibs
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject IJSRuntime JS

@rendermode InteractiveServer

@attribute [Authorize(Roles = "Admin")]

<h3 class="page-title"><u>Support Ticket Report</u></h3>

<div class="card p-3 shadow-sm" style="border-radius: 20px;">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">All Tickets</h5>
        <button class="btn btn-outline-success shadow-sm" @onclick="ExportToExcel">
            <i class="bi bi-file-earmark-excel me-2"></i>Export to Excel
        </button>
    </div>

    
    <RadzenDataGrid Data="@DisplayedTickets" TItem="Ticket"
                    AllowFiltering="true" FilterMode="FilterMode.Simple"
                    AllowSorting="true" AllowPaging="true" PageSize="10"
                    PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                    ColumnWidth="200px" SelectionMode="DataGridSelectionMode.Single"
                    class="rz-shadow-2" style="border-radius: 15px; overflow: hidden;">
        <Columns>
            <RadzenDataGridColumn TItem="Ticket" Property="Id" Title="ID" Width="80px" Frozen="true" />
            <RadzenDataGridColumn TItem="Ticket" Property="Title" Title="Subject" Width="250px" />

            <RadzenDataGridColumn TItem="Ticket" Property="Status" Title="Status">
                <Template Context="ticket">
                    @if (ticket.Status == "Open")
                    {
                        <span class="badge bg-info text-dark">Open</span>
                    }
                    else if (ticket.Status == "In Progress")
                    {

                        <span class="badge bg-warning text-dark">In Progress</span>
                    }
                    else
                    {

                        <span class="badge bg-success">Closed</span>
                    }
                </Template>
            </RadzenDataGridColumn>

            <RadzenDataGridColumn TItem="Ticket" Property="Category" Title="Category" />

            
            <RadzenDataGridColumn TItem="Ticket" Property="CreatedAt" Title="Created Date" Width="200px">
                <Template Context="ticket">
                    @ticket.CreatedAt?.ToLocalTime().ToString("d")
                </Template>
                
                <FilterTemplate>
                    <RadzenDatePicker @bind-Value="@filterDate"
                                      DateFormat="d"
                                      Change="@OnDateFilterChange"
                                      ShowTime="false"
                                      AllowClear="true"
                                      Placeholder="Filter by Date"
                                      class="w-100" />
                </FilterTemplate>
            </RadzenDataGridColumn>

        </Columns>
    </RadzenDataGrid>
</div>

@code {
    private List<Ticket>? tickets; 
    private DateTime? filterDate;  

    private List<Ticket> DisplayedTickets => tickets?
    .Where(t => !filterDate.HasValue ||
               (t.CreatedAt.HasValue && t.CreatedAt.Value.ToLocalTime().Date == filterDate.Value.Date))
    .ToList() ?? new();

    protected override async Task OnInitializedAsync()
    {
        using var context = await DbFactory.CreateDbContextAsync();        
        tickets = await context.Tickets.ToListAsync();
    }

    private void OnDateFilterChange(DateTime? value)
    {
        filterDate = value;
        StateHasChanged();
    }
    
    private async Task ExportToExcel()
    {
        var dataToExport = DisplayedTickets;
        if (!dataToExport.Any()) return;

        using var memoryStream = new MemoryStream();
        memoryStream.SaveAs(dataToExport);
        memoryStream.Seek(0, SeekOrigin.Begin);

        var fileName = $"TicketReport_{DateTime.Now:yyyyMMdd}.xlsx";
        using var streamRef = new DotNetStreamReference(stream: memoryStream);
        await JS.InvokeVoidAsync("downloadFileFromStream", fileName, streamRef);
    }
}
